{% extends "base.html" %}

{% block title %}Chat - Demand Letter Generator{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 15px;
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: 600;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        animation: fadeInUp 0.3s ease;
    }

    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    .bot-message {
        background: white;
        color: #333;
        align-self: flex-start;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }

    .bot-message .message-time {
        text-align: left;
    }

    .chat-input-container {
        padding: 1rem;
        background: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        resize: none;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        padding: 12px 16px;
        font-family: inherit;
        font-size: 1rem;
        max-height: 120px;
        min-height: 44px;
    }

    .chat-input:focus {
        border-color: #667eea;
        outline: none;
    }

    .send-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .typing-indicator {
        display: none;
        align-self: flex-start;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 18px;
        border-bottom-left-radius: 5px;
        padding: 12px 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .typing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .empty-chat {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        text-align: center;
        padding: 2rem;
    }

    .empty-chat i {
        font-size: 4rem;
        color: #667eea;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 70vh;
        }
        
        .message {
            max-width: 90%;
        }
        
        .chat-input-container {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card" data-aos="fade-up">
    <h1 style="text-align: center; margin-bottom: 2rem; color: #333;">
        <i class="fas fa-comments" style="color: #667eea;"></i> AI Chat Assistant for Future Improvements
    </h1>
    
    <div class="chat-container" data-aos="fade-up" data-aos-delay="200">
        <div class="chat-header">
            <i class="fas fa-robot"></i> Legal Assistant - Ask me anything about demand letters!
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% if history %}
                <!-- {% for msg in history %}
                    <div class="message user-message">
                        {{ msg[0] }}
                        <div class="message-time">{{ msg[2][:19] }}</div>
                    </div>
                    <div class="message bot-message">
                        {{ msg[1] }}
                        <div class="message-time">{{ msg[2][:19] }}</div>
                    </div>
                {% endfor %} -->
                 <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <h3>Start a Conversation</h3>
                    <p>Let me know anything you want to imrove about demand letters, legal procedures, or document generation.</p>
                </div>

            {% else %}
                <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <h3>Start a Conversation</h3>
                    <p> Let me know anything if you want to improve about demand letters, legal procedures, or document generation.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea id="chatInput" 
                      class="chat-input" 
                      placeholder="Type your message here..." 
                      rows="1"></textarea>
            <button id="sendButton" class="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<div class="card" data-aos="fade-up" data-aos-delay="400">
    <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">
        <i class="fas fa-lightbulb" style="color: #667eea;"></i> Sample Questions
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        <button class="sample-question btn" style="background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; text-align: left; padding: 1rem;">
            <i class="fas fa-question-circle" style="color: #667eea;"></i>
            What information should I include in a demand letter?
        </button>
        
        <button class="sample-question btn" style="background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; text-align: left; padding: 1rem;">
            <i class="fas fa-question-circle" style="color: #667eea;"></i>
            How do I format my CSV file for the generator?
        </button>
        
        <button class="sample-question btn" style="background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; text-align: left; padding: 1rem;">
            <i class="fas fa-question-circle" style="color: #667eea;"></i>
            What are the legal requirements for demand letters?
        </button>
        
        <button class="sample-question btn" style="background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; text-align: left; padding: 1rem;">
            <i class="fas fa-question-circle" style="color: #667eea;"></i>
            How long should I wait for a response to my demand letter?
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Auto-resize textarea
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send message on Enter (but allow Shift+Enter for new lines)
chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Send button click
sendButton.addEventListener('click', sendMessage);

// Sample question buttons
document.querySelectorAll('.sample-question').forEach(button => {
    button.addEventListener('click', function() {
        const question = this.textContent.trim().replace('?', '').split('?')[0] + '?';
        chatInput.value = question;
        chatInput.focus();
        sendMessage();
    });
});

function addMessage(message, isUser = true) {
    // Remove empty chat message if it exists
    const emptyChat = chatMessages.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    
    const now = new Date();
    const timeString = now.toLocaleString().slice(0, 19);
    
    messageDiv.innerHTML = `
        ${message}
        <div class="message-time">${timeString}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function showTyping() {
    typingIndicator.style.display = 'block';
    scrollToBottom();
}

function hideTyping() {
    typingIndicator.style.display = 'none';
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    // Disable input and button
    chatInput.disabled = true;
    sendButton.disabled = true;
    
    // Add user message
    addMessage(message, true);
    
    // Clear input
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    // Show typing indicator
    showTyping();
    
    try {
        const response = await fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const result = await response.json();
        
        // Hide typing indicator
        hideTyping();
        
        if (result.response) {
            addMessage(result.response, false);
        } else {
            addMessage('Sorry, I couldn\'t process your message. Please try again.', false);
        }
        
    } catch (error) {
        console.error('Error sending message:', error);
        hideTyping();
        addMessage('Sorry, there was a network error. Please try again.', false);
    } finally {
        // Re-enable input and button
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
    }
}

// Focus on input when page loads
document.addEventListener('DOMContentLoaded', function() {
    chatInput.focus();
    scrollToBottom();
});
</script>
{% endblock %}

